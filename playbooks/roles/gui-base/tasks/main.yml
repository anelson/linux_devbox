---
# tasks file for roles/gui-base
- name: Ensure dnf plugins are present
  dnf:
    name: dnf-plugins-core
    state: present

- name: install alacritty
  dnf:
    name: alacritty
    state: present

- name: Enable vivaldi repo
  command:
    cmd: dnf config-manager --add-repo https://repo.vivaldi.com/archive/vivaldi-fedora.repo
  args:
    creates: /etc/yum.repos.d/vivaldi.repo

- name: install Vivaldi from a custom repo
  dnf:
    name: vivaldi-stable
    enablerepo: vivaldi
    state: present

- name: Enable Brave repo
  yum_repository:
    name: brave
    description: Brave browser repo
    baseurl: https://brave-browser-rpm-release.s3.brave.com/x86_64/
    skip_if_unavailable: yes
    gpgkey: https://brave-browser-rpm-release.s3.brave.com/brave-core.asc
    repo_gpgcheck: no
    enabled: yes

- name: install Brave from a custom repo
  dnf:
    name: brave-browser
    enablerepo: brave
    state: present

- name: Enable VS Code repo
  yum_repository:
    name: code
    description: Visual Studio Code repo
    baseurl: https://packages.microsoft.com/yumrepos/vscode
    skip_if_unavailable: yes
    gpgkey: https://packages.microsoft.com/keys/microsoft.asc
    repo_gpgcheck: no
    enabled: yes

- name: install VS Code from custom repo
  dnf:
    name: code
    enablerepo: code
    state: present

- name: Enable 1Password repo
  yum_repository:
    name: 1password
    description: 1Password Stable Channel
    baseurl: https://downloads.1password.com/linux/rpm/stable/$basearch
    skip_if_unavailable: yes
    gpgkey: https://downloads.1password.com/linux/keys/1password.asc
    repo_gpgcheck: no
    enabled: yes

- name: install 1Password from repo
  dnf:
    name: 1password
    enablerepo: 1password
    state: present

- name: Ensure Vivaldi is trusted by 1P so the extension will work there.
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: "{{ item }}"
    state: present
    create: yes
    owner: root
    group: root
    mode: '0644'
  loop:
    # I'm not sure which of these lines actually makes Vivaldi work.  I have both on my system where I did
    # this manually.  The docs are ambiguous.  Anyway this definitely works.
    - vivaldi-bin
    - /opt/vivaldi/vivaldi-bin

#- name: Enable waybar Copr repo
#  # Info came from this: https://copr.fedorainfracloud.org/coprs/alebastr/waybar/repo/fedora-32/alebastr-waybar-fedora-32.repo
#  yum_repository:
#    name: waybar
#    description: Copr repo for waybar owned by alebastr
#    baseurl: https://download.copr.fedorainfracloud.org/results/alebastr/waybar/fedora-$releasever-$basearch/
#    skip_if_unavailable: yes
#    gpgkey: https://download.copr.fedorainfracloud.org/results/alebastr/waybar/pubkey.gpg
#    repo_gpgcheck: no
#    enabled: yes
#
#- name: install waybar from a custom repo
#  dnf:
#    name: waybar
#    enablerepo: waybar
#    state: present

- name: install base system packages that require X or Wayland
  dnf:
    name: "{{ lookup('flattened', item) }}"
    state: present
  become: yes
  loop:
      - "{{ xorg_packages }}"
      - "{{ wayland_packages }}"
      - "{{ gui_packages }}"
      - "{{ theme_packages }}"
      - "{{ wine_packages }}"

- import_tasks: configure-gdm.yml
- import_tasks: configure-wine.yml
#Disabling this; I hope Fedora has a sensible default already.  If not, then revisit
#- import_tasks: configure-fontconfig.yml

- name: Enable the default flathub flatpak repo
  flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
    method: system

- name: install flatpak packages
  flatpak:
    name: "{{ item }}"
  loop: "{{ flatpak_packages }}"

- name: Install dropbox RPM
  dnf:
    name: "{{ dropbox_rpm_url }}"
    state: present
    use_backend: dnf5
    disable_gpg_check: yes

- name: Install zoom RPM
  dnf:
    name: "{{ zoom_rpm_url }}"
    state: present
    disable_gpg_check: yes

- name: Ensure dconf directory exists for machine-wide Gnome settings
  ansible.builtin.file:
    path: /etc/dconf/db/local.d
    state: directory
    mode: '0755'

- name: Set Caps Lock to act as Escape in Gnome
  ansible.builtin.copy:
    dest: /etc/dconf/db/local.d/00-keyboard-remap
    content: |
      [org/gnome/desktop/input-sources]
      xkb-options=['caps:escape']
    mode: '0644'

- name: Compile Gnome dconf settings
  ansible.builtin.shell: dconf update
  args:
    executable: /bin/bash
